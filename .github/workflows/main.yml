name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        # ä½¿ç”¨æ‚¨æœåŠ¡å™¨ä¸Š Git Bash çš„ç¡®åˆ‡è·¯å¾„
        shell: F:\git\Git\bin\bash.exe -e -o pipefail {0}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: Mark git directory as safe
        run: git config --global --add safe.directory "${{ github.workspace }}"
      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.24' # å»ºè®®ä½¿ç”¨æ‚¨çš„é¡¹ç›®æ‰€ç”¨çš„Goç‰ˆæœ¬

      - name: ä¸‹è½½åç«¯ä¾èµ– (Go Modules)
        working-directory: ./smart_fox2 # å‡è®¾æ‚¨çš„ go.mod æ–‡ä»¶åœ¨ backend ç›®å½•ä¸‹
        env:
          GOPROXY: https://goproxy.cn,direct
        run: go mod download
    
      - name: æ„å»ºåç«¯ (Go Gin)
        working-directory: ./smart_fox2
        env:
          CGO_ENABLED: 0
          GOOS: linux
        run: go build -v -o myapp .

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
      
      - name: å®‰è£…å¹¶æ„å»ºå‰ç«¯
        working-directory: ./front
        env:
          CI: false
        run: |
          npm ci
          npm run build

      - name: å¸è½½ç°æœ‰åº”ç”¨
        run: |
          echo "å¸è½½ç°æœ‰Todoåº”ç”¨..."
   
          # åˆ é™¤å‰ç«¯æœåŠ¡
          kubectl delete -f k8s/frontend-deployment.yaml --ignore-not-found=true || true
          
          # åˆ é™¤åç«¯æœåŠ¡
          kubectl delete -f k8s/backend-deployment.yaml --ignore-not-found=true || true
          # åˆ é™¤judge
          kubectl delete -f k8s/judge-deployment.yaml --ignore-not-found=true || true
          
          # åˆ é™¤MySQLç›¸å…³èµ„æº
          kubectl delete -f k8s/mysql-deployment.yaml --ignore-not-found=true || true
          
          # åˆ é™¤é…ç½®å’Œå¯†é’¥
          kubectl delete -f k8s/mysql-pvc.yaml --ignore-not-found=true || true
          kubectl delete -f k8s/mysql-secret.yaml --ignore-not-found=true || true
          
          # åˆ é™¤å‘½åç©ºé—´ï¼ˆè¿™ä¼šåˆ é™¤å‘½åç©ºé—´å†…çš„æ‰€æœ‰èµ„æºï¼‰
          kubectl delete namespace todo-app --ignore-not-found=true || true
          
          # ç­‰å¾…å‘½åç©ºé—´åˆ é™¤å®Œæˆ
          kubectl wait --for=delete namespace/todo-app --timeout=300s 2>/dev/null || true
          
          echo "å¸è½½å®Œæˆï¼Œå¼€å§‹é‡æ–°éƒ¨ç½²..."

      - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
        run: |
          
          # æ„å»ºåç«¯é•œåƒ
          # æ³¨æ„ï¼šè¿™é‡Œçš„ --load æ˜¯ä¸ºäº†åœ¨ buildx ä¸­ç›´æ¥å°†é•œåƒåŠ è½½åˆ°æœ¬åœ° docker imagesï¼Œå¦‚æœæ‚¨çš„ runner ç¯å¢ƒä¸åŒï¼Œå¯èƒ½éœ€è¦è°ƒæ•´
          docker build -t todo-backend:latest -f smart_fox2/Dockerfile ./smart_fox2 --load
          docker build -t todo-frontend:latest -f front/Dockerfile ./front --load
          docker build -t todo-judge:latest -f smart_fox2/Judger/Dockerfile ./smart_fox2/Judger --load

          # æ•°æ®åº“é•œåƒé€šå¸¸ç›´æ¥ä½¿ç”¨å®˜æ–¹é•œåƒï¼Œæ— éœ€æœ¬åœ°æ„å»º

      - name: éƒ¨ç½²åˆ°Kubernetes
        run: |
          # åˆ›å»ºå‘½åç©ºé—´
          kubectl apply -f k8s/namespace.yaml

          # éƒ¨ç½²MySQL (å‡è®¾æ‚¨ä»åœ¨ä½¿ç”¨MySQL)
          kubectl apply -f k8s/mysql-secret.yaml
          kubectl apply -f k8s/mysql-pvc.yaml
          kubectl apply -f k8s/mysql-deployment.yaml

          # ç­‰å¾…MySQLå°±ç»ª
          echo "ç­‰å¾…MySQL Podå°±ç»ª..."
          kubectl wait --for=condition=ready pod -l app=todo-database -n todo-app --timeout=5m

          # éƒ¨ç½²åç«¯ (Gin)
          kubectl apply -f k8s/backend-deployment.yaml

          # éƒ¨ç½²å‰ç«¯ (å¦‚æœå‰ç«¯æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„è¯)
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/judge-deployment.yaml

          # ç­‰å¾…æœåŠ¡å°±ç»ª
          echo "ç­‰å¾…åç«¯Podå°±ç»ª..."
          kubectl wait --for=condition=ready pod -l app=todo-backend -n todo-app --timeout=3m
          # echo "ç­‰å¾…å‰ç«¯Podå°±ç»ª..."
          kubectl wait --for=condition=ready pod -l app=todo-frontend -n todo-app --timeout=3m

      - name: éªŒè¯éƒ¨ç½²çŠ¶æ€
        run: |
          echo "éƒ¨ç½²å®Œæˆï¼æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š"
          kubectl get all -n todo-app

          echo "æŸ¥çœ‹PodçŠ¶æ€ï¼š"
          kubectl get pods -n todo-app

          echo "æŸ¥çœ‹æœåŠ¡ç«¯å£ï¼š"
          kubectl get svc -n todo-app

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… Todoåº”ç”¨éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€ (ç¤ºä¾‹): http://<your-node-ip>:3000"
          echo "ğŸ“Š æŸ¥çœ‹çŠ¶æ€: kubectl get all -n todo-app"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ Todoåº”ç”¨éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥CI/CDæµæ°´çº¿çš„æ—¥å¿—ä»¥åŠKubernetes Podçš„æ—¥å¿—ã€‚"
          echo "ğŸ“‹ æŸ¥çœ‹åç«¯æ—¥å¿—: kubectl logs -f deployment/todo-backend -n todo-app"
          echo "ğŸ” æŸ¥çœ‹Podè¯¦æƒ…: kubectl describe pods -l app=todo-backend -n todo-app"
